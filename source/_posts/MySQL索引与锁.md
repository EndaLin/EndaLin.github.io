---
title: MySQL索引与锁
copyright: true
date: 2019-06-03 10:58:02
tags: MySQL
---

# MySQL存储引擎的基础知识
- MySQL的基本存储结构是页，所有记录都存储在页里面。

![](https://user-gold-cdn.xitu.io/2018/7/23/164c6d7a53b78847?imageView2/0/w/1280/h/960/format/webp/ignore-error/1)

- 每个页之间组成的是一个双向链表。
- 每个数据页里面的记录可以组成一个单向链表。
> - 每个数据页都会为存储在本页里面的数据生成一个页目录，在通过主键查抄某条记录时可以使用二分法快速定位
>- 而根据其它列进行检索时，就只能通过遍历的手段


在没有任何索引的的表中，select语句的执行会进行如下两次遍历
- 遍历双向链表，找到所在页
- 遍历页内的单链表，找到所在的记录

<!--more-->

# 索引提高检索速度
索引的主要作用就是将无序变成有序。

![](https://user-gold-cdn.xitu.io/2018/7/23/164c6d7a5663f62b?imageView2/0/w/1280/h/960/format/webp/ignore-error/1)

record_type=1 代表存放的是普通目录项的记录  
record_type=0 代表存放的是普通用户的记录

底层结构一般都是**B+树**，B+树是平衡树的一种，它是一个空树或者是左右子树的高度差的绝对值不会超过1，左右子树都是一颗平衡二叉树。深度为lgn

索引在提高检索速度的同时，同时会降低增删改的速度，因为要对B+树做增删改的话，会破坏它原来的结构，而且要维护平衡树，就必要做额外的工作。

# 聚集索引和非聚集索引
概括：
- 聚集索引是以**主键**创建的索引。
- 非聚集索引是以**非主键**创建的索引。
InnoDB要求表必须有主键（MyISAM可以没有），innodb会按照如下规则进行处理：
- 如果一个主键被定义了，那么这个主键就是作为聚集索引
- 如果没有主键被定义，那么该表的第一个唯一非空索引被作为聚集索引
- 如果没有主键也没有合适的唯一索引，那么innodb内部会生成一个隐藏的主键作为聚集索引，这个隐藏的主键是一个6个字节的列，改列的值会随着数据的插入自增。

区别：
- 聚集索引在叶子节点存储的是表中的数据。
- 非聚集索引在叶子节点存储的是主键和索引列。
- 使用非聚集索引查询出数据时，拿到叶子上的主键再去查想要查找的数据。（拿到主键再去查找的这个过程叫做**回表**）
- **聚集索引是物理上的连续，而非聚集索引是逻辑上的连续，物理存储并不连续。**
- 聚集索引：可以帮助把很大的范围，迅速减小范围。但是查找该记录，就要从这个小范围中Scan了。
- 非聚集索引：把一个很大的范围，转换成一个小的地图。你需要在这个小地图中找你要寻找的信息的位置。然后通过这个位置，再去找你所需要的记录。

覆盖索引：
- 如果不是聚集索引，叶子节点存储的是主键+索引列，如果需要查询的列，叶子节点都存在，那么就不用回表，提高效率。

![](https://img-blog.csdn.net/20170730213729731)

# 索引最左匹配原则
#### 最左匹配原则：

- 索引可以简单如一个列(a)，也可以复杂如多个列(a, b, c, d)，即联合索引。
- 如果是联合索引，那么key也由多个列组成，同时，索引只能用于查找key是否存在（相等），遇到范围查询(>、<、between、like左匹配)等就不能进一步匹配了，后续退化为线性查找。
- 因此，列的排列顺序决定了可命中索引的列数。

#### 例子：

- 如有索引(a, b, c, d)，查询条件a = 1 and b = 2 and c > 3 and d = 4，则会在每个节点依次命中a、b、c，无法命中d。(很简单：索引命中只能是相等的情况，不能是范围匹配)


# 索引总结
- 最左匹配原则
- 尽量选择区分度高的列作为索引
- 索引列不能参与计算，尽量保持列干净
- 尽可能扩展索引，不要新建立索引

# 参考资料
[MySQL索引与锁](https://juejin.im/post/5b55b842f265da0f9e589e79)
