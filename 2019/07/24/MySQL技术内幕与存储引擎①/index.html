<!DOCTYPE html>



  


<html class="theme-next gemini use-motion" lang>
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">








<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">




  
  
  
  

  

  

  

  

  

  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.2" rel="stylesheet" type="text/css">


  <meta name="keywords" content="MySQL,">








  <link rel="shortcut icon" type="image/x-icon" href="/images/favicon.ico?v=5.1.2">






<meta name="description" content="基本概念数据库： 文件的集合， 是依照某种数据模型组织起来并存放于二级存储器中的数据集合 数据库实例：程序， 位于用户与操作系统之间的一层数据管理软件， 用户对数据库的任何操作， 包括数据库定义、数据查询、数据维护、数据库运行控制等都是在数据库实例下运行的， 应用程序只有通过数据库实例才能和数据库打交道">
<meta name="keywords" content="MySQL">
<meta property="og:type" content="article">
<meta property="og:title" content="MySQL技术内幕与存储引擎①">
<meta property="og:url" content="https://wt-git-repository.github.io/2019/07/24/MySQL技术内幕与存储引擎①/index.html">
<meta property="og:site_name" content="Enda Lin">
<meta property="og:description" content="基本概念数据库： 文件的集合， 是依照某种数据模型组织起来并存放于二级存储器中的数据集合 数据库实例：程序， 位于用户与操作系统之间的一层数据管理软件， 用户对数据库的任何操作， 包括数据库定义、数据查询、数据维护、数据库运行控制等都是在数据库实例下运行的， 应用程序只有通过数据库实例才能和数据库打交道">
<meta property="og:locale" content="default">
<meta property="og:image" content="https://upload-images.jianshu.io/upload_images/13918038-eaf94c0cd303d3f4.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240">
<meta property="og:image" content="https://upload-images.jianshu.io/upload_images/13918038-fcfead69c2fc40a6.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240">
<meta property="og:image" content="https://upload-images.jianshu.io/upload_images/13918038-bc7ca51f7794f201.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240">
<meta property="og:image" content="https://upload-images.jianshu.io/upload_images/13918038-e72aea911f83c4a0.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240">
<meta property="og:image" content="https://upload-images.jianshu.io/upload_images/13918038-5c0053b9eedc45f5.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240">
<meta property="og:image" content="https://upload-images.jianshu.io/upload_images/13918038-1588298eacdfa291.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240">
<meta property="og:updated_time" content="2019-11-07T02:21:14.058Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="MySQL技术内幕与存储引擎①">
<meta name="twitter:description" content="基本概念数据库： 文件的集合， 是依照某种数据模型组织起来并存放于二级存储器中的数据集合 数据库实例：程序， 位于用户与操作系统之间的一层数据管理软件， 用户对数据库的任何操作， 包括数据库定义、数据查询、数据维护、数据库运行控制等都是在数据库实例下运行的， 应用程序只有通过数据库实例才能和数据库打交道">
<meta name="twitter:image" content="https://upload-images.jianshu.io/upload_images/13918038-eaf94c0cd303d3f4.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://wt-git-repository.github.io/2019/07/24/MySQL技术内幕与存储引擎①/">





  <title>MySQL技术内幕与存储引擎① | Enda Lin</title>
  














</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="default">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Enda Lin</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">keep foolish, keep sharp</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br>
            
            Categories
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br>
            
            About
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            Archives
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>
            
            Tags
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://wt-git-repository.github.io/2019/07/24/MySQL技术内幕与存储引擎①/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Enda Lin">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avator.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Enda Lin">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">MySQL技术内幕与存储引擎①</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-07-24T11:20:55+08:00">
                2019-07-24
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2019/07/24/MySQL技术内幕与存储引擎①/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2019/07/24/MySQL技术内幕与存储引擎①/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          
            <span class="post-meta-divider">|</span>
            <span class="page-pv"><i class="fa fa-file-o"></i> 浏览
            <span class="busuanzi-value" id="busuanzi_value_page_pv"></span>次
            </span>
          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Words count in article</span>
                
                <span title="Words count in article">
                  2.8k
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Reading time</span>
                
                <span title="Reading time">
                  9
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h1 id="基本概念"><a href="#基本概念" class="headerlink" title="基本概念"></a>基本概念</h1><p><strong>数据库</strong>： 文件的集合， 是依照某种数据模型组织起来并存放于二级存储器中的数据集合</p>
<p><strong>数据库实例</strong>：程序， 位于用户与操作系统之间的一层数据管理软件， 用户对数据库的任何操作， 包括数据库定义、数据查询、数据维护、数据库运行控制等都是在数据库实例下运行的， 应用程序只有通过数据库实例才能和数据库打交道</p>
<p><img src="https://upload-images.jianshu.io/upload_images/13918038-eaf94c0cd303d3f4.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"></p>
<a id="more"></a>
<h1 id="连接MySQL"><a href="#连接MySQL" class="headerlink" title="连接MySQL"></a>连接MySQL</h1><h2 id="TCP-IP"><a href="#TCP-IP" class="headerlink" title="TCP/IP"></a>TCP/IP</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql -h127.0.0.1 -u root -p</span><br></pre></td></tr></table></figure>
<h1 id="InnoDB-体系架构"><a href="#InnoDB-体系架构" class="headerlink" title="InnoDB 体系架构"></a>InnoDB 体系架构</h1><p><img src="https://upload-images.jianshu.io/upload_images/13918038-fcfead69c2fc40a6.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"></p>
<p>后台线程的主要作用是负责刷新内存池的数据，保证缓冲池中的内存缓存的是最近的数据。此外将已修改的数据文件刷新到磁盘文件，同时保证在数据库发生异常的情况下，InnoDB 能恢复到正常运行状态。</p>
<h2 id="后台线程"><a href="#后台线程" class="headerlink" title="后台线程"></a>后台线程</h2><h3 id="Master-Thread"><a href="#Master-Thread" class="headerlink" title="Master Thread"></a>Master Thread</h3><p>Master Thread 是一个非常核心的后台线程，主要负责将缓冲池中的数据异步刷新到磁盘，保证数据的一致性</p>
<h3 id="IO-Thread"><a href="#IO-Thread" class="headerlink" title="IO Thread"></a>IO Thread</h3><p>在InnoDB 存储引擎中大量使用AIO（Async IO） 来处理读写IO 请求，这样可以极大提高数据库的性能</p>
<h3 id="Purge-Thread"><a href="#Purge-Thread" class="headerlink" title="Purge Thread"></a>Purge Thread</h3><p>事务被提交后，其所使用的undolog 可能不再需要，因此需要PurgeThread 来回收已经使用并分配的undo 页。</p>
<h3 id="Page-Cleaner-Thread"><a href="#Page-Cleaner-Thread" class="headerlink" title="Page Cleaner Thread"></a>Page Cleaner Thread</h3><p>将之前版本中脏页的刷新操作都放入到单独的线程中</p>
<h2 id="内存"><a href="#内存" class="headerlink" title="内存"></a>内存</h2><h3 id="缓冲池"><a href="#缓冲池" class="headerlink" title="缓冲池"></a>缓冲池</h3><p>InnoDB 存储引擎是基于磁盘存储的，并将其中的记录按照页的方式进行管理，在数据库系统中，由于CPU 速度与磁盘速度之间的鸿沟，基于磁盘的数据库系统通常使用缓冲池技术来提高数据库的整体性能。</p>
<p>在数据库中进行<strong>读取页</strong>的操作，首先将从磁盘读到的页放在缓冲池中，这个过程称为将页“FIX” 在缓冲池，下一次再读相同的页时，该页在缓冲池中被命中，直接读取该页，否则读取磁盘上的页。</p>
<p>在数据库中<strong>修改页</strong>的操作，则首先修改缓冲池的页，然后再以一定频率刷新到磁盘上。</p>
<p><img src="https://upload-images.jianshu.io/upload_images/13918038-bc7ca51f7794f201.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"></p>
<h2 id="文件"><a href="#文件" class="headerlink" title="文件"></a>文件</h2><ul>
<li><p>参数文件：配置参数，用来寻找数据库各种文件所在位置以及指定某些初始化参数，，my.cnf</p>
</li>
<li><ul>
<li>什么是参数：可以把数据库参数看成一个键值对</li>
</ul>
</li>
<li><ul>
<li>参数类型：动态参数和静态参数</li>
</ul>
</li>
<li><p>日志文件：记录MySQL 实例对某种条件作出响应时写入的文件，如错误日志、查询日志等等</p>
</li>
<li><ul>
<li>错误日志：对MySQL 的启动、运行、关闭过程进行了记录</li>
</ul>
</li>
<li><ul>
<li>慢查询日志：将运行时间超过指定阀值的所有SQL 语句都记录到慢查询日志文件中，默认是10秒</li>
</ul>
</li>
<li><ul>
<li>查询日志：记录所有对MySQL 数据库请求的信息，无论这些请求是否得到了执行</li>
</ul>
</li>
<li><ul>
<li>二进制文件：记录了对MySQL 数据库执行更改的所有操作</li>
</ul>
</li>
<li>socket 文件：使用UNIX 域套接字方式进行连接时需要的文件</li>
<li>pid 文件：MySQL 实例的进程ID 文件</li>
<li>MySQL 表结构文件：用来存放MySQL 表结构定义文件</li>
<li>存储引擎文件</li>
</ul>
<h2 id="表"><a href="#表" class="headerlink" title="表"></a>表</h2><h3 id="索引组织表"><a href="#索引组织表" class="headerlink" title="索引组织表"></a>索引组织表</h3><p>在InnoDB 存储引擎中，表都是根据主键顺序组织存放的，这种存储方式的表称为索引组织表。</p>
<p>在InnoDB 存储引擎表中，每张表都有一个主键（Primary key），如果在创建表时没有显式地定义主键，那么InnoDB 存储引擎会按如下方式选择或者创建主键：</p>
<ul>
<li>首先判断表中是否有非空的唯一索引，如果有，则该列为主键（选择第一个被定义的非空唯一索引）</li>
<li>如果不符合上述条件，InnoDB 存储引擎将选择表时第一个定义的非空唯一索引为主键。</li>
</ul>
<h3 id="InnoDB-逻辑存储结构"><a href="#InnoDB-逻辑存储结构" class="headerlink" title="InnoDB 逻辑存储结构"></a>InnoDB 逻辑存储结构</h3><p><img src="https://upload-images.jianshu.io/upload_images/13918038-e72aea911f83c4a0.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"></p>
<p><strong>表空间：</strong> 表空间可以看做是InnoDB 存储引擎逻辑结构的最高层，所有的数据都存放在表空间中。</p>
<p><strong>段：</strong> 表空间是由各个段组成的，常见的段有数据段、索引段、回滚段等等。</p>
<p>InnoDB 存储引擎表是索引组织的，因此数据即索引，那么数据段即为<strong>B+树的叶子节点（Leaf node segment）</strong></p>
<p>索引段即为<strong>B+树的非索引节点（Non-leaf node segment）</strong></p>
<p><strong>区</strong>是由连续页组成的空间，在任何情况下，每个区的大小都为1 MB，在默认情况下，InnoDB 存储引擎页的大小为16KB，即一个区中一共有16 个连续的页。</p>
<p><strong>页</strong>是InnoDB 磁盘管理的最小单位，在InnoDB 存储引擎中，默认每个页的大小为16KB</p>
<p>在InnoDB 存储引擎中，常见的页类型有：</p>
<ul>
<li>数据页</li>
<li>undo 页</li>
<li>系统页</li>
<li>事务数据页</li>
<li>插入缓冲位图页</li>
<li>插入缓冲空闲列表页</li>
<li>未压缩的二进制大对象页</li>
<li>压缩的二进制大对象页</li>
</ul>
<p>数据页存放的是完整的每行的记录</p>
<p>非数据页的索引页，存放的是键值及指向数据页的偏移量</p>
<p><strong>行</strong>：InnoDB 存储引擎，数据是按行进行存放的</p>
<h3 id="InnoDB-行记录格式"><a href="#InnoDB-行记录格式" class="headerlink" title="InnoDB 行记录格式"></a>InnoDB 行记录格式</h3><p>InnoDB 存储引擎提供了Compact 和Redundant 两种格式来存放行记录数据</p>
<h4 id="Compact-行记录格式"><a href="#Compact-行记录格式" class="headerlink" title="Compact 行记录格式"></a>Compact 行记录格式</h4><p>代办</p>
<h2 id="索引与算法"><a href="#索引与算法" class="headerlink" title="索引与算法"></a>索引与算法</h2><p>InnoDB 存储引擎支持</p>
<ul>
<li>B+ 树索引</li>
<li>全文索引</li>
<li>哈希索引</li>
</ul>
<p>B+ 树索引并不能找到一个给定键值的具体行，B+树索引能找到的只是被查找数据行的所在的页，然数据库通过把页读到内存，再从内存中进行查找，最后得到要查找的数据。</p>
<p><img src="https://upload-images.jianshu.io/upload_images/13918038-5c0053b9eedc45f5.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"></p>
<h3 id="聚集索引"><a href="#聚集索引" class="headerlink" title="聚集索引"></a>聚集索引</h3><p>聚集索引是按照每张表的主键构造一课B+ 树，同时叶子节点存放的就是整张表的行记录数据，也将聚集索引的叶子节点成为数据页</p>
<p>聚集索引的存储并不是物理上连续，而是逻辑上连续</p>
<h3 id="非聚集索引"><a href="#非聚集索引" class="headerlink" title="非聚集索引"></a>非聚集索引</h3><p>对于非聚集索引，叶子节点并不包含记录的全部数据，叶子节点除了包含键值对以外，每个叶子节点的索引行还包括一个书签，这个书签用来告诉InnoDB 引擎哪里可以找到与索引对应的行数据，由于InnoDB 存储引擎表是索引组织表，因此InnoDB 存储引擎的辅助索引的书签就是相应的行数据的聚集索引键</p>
<h3 id="聚集索引和非聚集索引的关系"><a href="#聚集索引和非聚集索引的关系" class="headerlink" title="聚集索引和非聚集索引的关系"></a>聚集索引和非聚集索引的关系</h3><p>非聚集索引的存在并不影响聚集索引的组织，因此每张表上可以有多个辅助索引。当通过非聚集索引来寻找数据的时候，InnoDB 存储引擎会遍历非聚集索引并通过叶级别的指针获得指向主键索引的主键，然后再通过主键索引来找到一个完整的行记录。</p>
<p><img src="https://upload-images.jianshu.io/upload_images/13918038-1588298eacdfa291.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"></p>
<h2 id="Cardinality-值"><a href="#Cardinality-值" class="headerlink" title="Cardinality 值"></a>Cardinality 值</h2><h3 id="什么时候添加B-树索引会比较合适"><a href="#什么时候添加B-树索引会比较合适" class="headerlink" title="什么时候添加B+ 树索引会比较合适"></a>什么时候添加B+ 树索引会比较合适</h3><p>对于列值具有高选择性的添加索引会有意义</p>
<p><strong>高选择性</strong>是某个字段选取的值范围很广，几乎没有重复</p>
<h3 id="如何查看索引是否是高选择性"><a href="#如何查看索引是否是高选择性" class="headerlink" title="如何查看索引是否是高选择性"></a>如何查看索引是否是高选择性</h3><p>可以通过SHOW INDEX 的结果中的Cardinality 值来观察</p>
<h3 id="什么是Cardinality-值"><a href="#什么是Cardinality-值" class="headerlink" title="什么是Cardinality 值"></a>什么是Cardinality 值</h3><p>Cardinality 值是一个预估值，表示索引中不重复记录数量的预估值</p>
<p>在实际应用中，<strong>Cardinality / n_rows_in_table</strong> 需要非常接近1，在访问高选择性属性的字段并从表中取出很少一部分数据的时候，对这个字段添加B+ 树索引是非常必要的。</p>
<h3 id="InnoDB-是如何统计Cardinality"><a href="#InnoDB-是如何统计Cardinality" class="headerlink" title="InnoDB 是如何统计Cardinality"></a>InnoDB 是如何统计Cardinality</h3><p>在InnoDB 存储引擎中，Cardinality 统计信息的更新发生在两个操作中：INSERT and UPDATE。</p>
<p>如果一张表有50GB 的数据，那么统计一次Cardinality 会耗费非常多的时间，这样会增加数据库的负荷，因此，InnoDB 存储引擎内部对更新Cardinality 信息的策略是：</p>
<ul>
<li>表中1/16 的数据已经发生过了变化</li>
<li>stat_modified_counter &gt; 2 000 000 000 (stat_modified_counter 是数据发生变化的次数)</li>
</ul>
<h2 id="锁"><a href="#锁" class="headerlink" title="锁"></a>锁</h2><h3 id="lock-and-latch"><a href="#lock-and-latch" class="headerlink" title="lock and latch"></a>lock and latch</h3><p>latch 一般称之为轻量级的锁，其要求上锁的时间必须是非常短的，在InnoDB 存储引擎中，latch 又分为mutex 互斥锁和relock 读写锁，其目的都是用来保证并发线程操作临界资源的正确性。</p>
<p>lock 的对象一般是事务，用来锁定数据库中的对象，如表、页、行。一般lock 的对象是在事务commit 或者rollback 后进行释放。</p>
<h3 id="InnoDB-存储引擎中的锁"><a href="#InnoDB-存储引擎中的锁" class="headerlink" title="InnoDB 存储引擎中的锁"></a>InnoDB 存储引擎中的锁</h3><h4 id="锁lock-的类型"><a href="#锁lock-的类型" class="headerlink" title="锁lock 的类型"></a>锁lock 的类型</h4><p>InnoDB 存储引擎实现了如下两种标准的行级锁：</p>
<ul>
<li><strong>共享锁S Lock</strong>： 允许事务读一行数据</li>
<li><strong>排他锁X Lock</strong>: 允许事务删除或者更新一行数据</li>
</ul>
<h4 id="一致性非锁定读"><a href="#一致性非锁定读" class="headerlink" title="一致性非锁定读"></a>一致性非锁定读</h4><p>一致性非锁定读是指如果读取的行被加了X 锁，这时候读操作并不会等待行锁的释放，而是去读取行的快照，行的快照指的是该行之前版本的数据，该实现是通过undo 段来完成的，而undo 用来在事务中回滚数据的，读取快照数据也不需要上锁，因为没有事务需要对历史数据进行操作。</p>
<h4 id="一致性锁定读"><a href="#一致性锁定读" class="headerlink" title="一致性锁定读"></a>一致性锁定读</h4><h3 id="死锁"><a href="#死锁" class="headerlink" title="死锁"></a>死锁</h3><h4 id="死锁避免"><a href="#死锁避免" class="headerlink" title="死锁避免"></a>死锁避免</h4><ul>
<li>超时： 两个事务互相等待，当其中一个事务的等待时间超过了阈值，事务就会进行回滚，另一个等待的事务就会继续进行下去。</li>
<li>wait-for graph （等待图）</li>
</ul>
<h2 id="事务"><a href="#事务" class="headerlink" title="事务"></a>事务</h2><p>ACID</p>
<ul>
<li>原子性：要么做，要么都不做</li>
<li>一致性：指的是事务将数据库从一种状态转移到下一种一致状态</li>
<li>隔离性：每个读写操作的事务对其它事务的操作不影响</li>
<li>持久性：事务一旦提交，其结果就是永久性的</li>
</ul>
<h2 id="事务的实现"><a href="#事务的实现" class="headerlink" title="事务的实现"></a>事务的实现</h2><h3 id="redo"><a href="#redo" class="headerlink" title="redo"></a>redo</h3><p>重做日志用来实现事务的持久性，即ACID 中的D，其由两部分组成，一是内存中的重做日志缓存，二是重做日志文件</p>
<p>重做日志在InnoDB 中是由两部分组成的：redo log和undo log, redo log保证事务的持久性，undo log 用来帮助事务回滚及MVCC 的功能</p>
<p>为了确保每次日志都写入了重做日志文件，在每次将重做日志缓冲写入到重做日志文件后，InnoDB 存储引擎都将调用一次fsync 操作</p>
<p>重做日志记录了事务的行为，可以很好地通过其对页进行重做操作</p>
<h3 id="undo"><a href="#undo" class="headerlink" title="undo"></a>undo</h3><p>事务的回滚，需要用到undo 的信息将数据回滚到修改之前的样子。</p>

      
    </div>
    
    
    

    <div>
      
        
<div class="my_post_copyright">
  <script src="//cdn.bootcss.com/clipboard.js/1.5.10/clipboard.min.js"></script>

  <!-- JS库 sweetalert 可修改路径 -->
  <script src="https://cdn.bootcss.com/jquery/2.0.0/jquery.min.js"></script>
  <script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>
  <p><span>本文标题:</span><a href="/2019/07/24/MySQL技术内幕与存储引擎①/">MySQL技术内幕与存储引擎①</a></p>
  <p><span>文章作者:</span><a href="/" title="访问 Enda Lin 的个人博客">Enda Lin</a></p>
  <p><span>发布时间:</span>2019年07月24日 - 11:20</p>
  <p><span>最后更新:</span>2019年11月07日 - 10:21</p>
  <p><span>原始链接:</span><a href="/2019/07/24/MySQL技术内幕与存储引擎①/" title="MySQL技术内幕与存储引擎①">https://wt-git-repository.github.io/2019/07/24/MySQL技术内幕与存储引擎①/</a>
    <span class="copy-path" title="点击复制文章链接"><i class="fa fa-clipboard" data-clipboard-text="https://wt-git-repository.github.io/2019/07/24/MySQL技术内幕与存储引擎①/" aria-label="复制成功！"></i></span>
  </p>
  <p><span>许可协议:</span><i class="fa fa-creative-commons"></i> <a rel="license" href="https://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank" title="Attribution-NonCommercial-NoDerivatives 4.0 International (CC BY-NC-ND 4.0)">署名-非商业性使用-禁止演绎 4.0 国际</a> 转载请保留原文链接及作者。</p>
</div>
<script>
    var clipboard = new Clipboard('.fa-clipboard');
    $(".fa-clipboard").click(function(){
      clipboard.on('success', function(){
        swal({
          title: "",
          text: '复制成功',
          icon: "success",
          showConfirmButton: true
          });
	});
    });
</script>


      
    </div>

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/MySQL/" rel="tag"># MySQL</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2019/07/18/Netty学习笔记/" rel="next" title="Netty学习笔记">
                <i class="fa fa-chevron-left"></i> Netty学习笔记
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2019/08/03/docker-Swarm/" rel="prev" title="docker-Swarm">
                docker-Swarm <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
      <div class="ds-thread" data-thread-key="2019/07/24/MySQL技术内幕与存储引擎①/" data-title="MySQL技术内幕与存储引擎①" data-url="https://wt-git-repository.github.io/2019/07/24/MySQL技术内幕与存储引擎①/">
      </div>
    
    <div id="gitalk-container"></div>
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            Table of Contents
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            Overview
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image" src="/images/avator.jpeg" alt="Enda Lin">
          <p class="site-author-name" itemprop="name">Enda Lin</p>
           
              <p class="site-description motion-element" itemprop="description">所有的伟大都是从零开始</p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives/">
                <span class="site-state-item-count">79</span>
                <span class="site-state-item-name">posts</span>
              </a>
            </div>
          

          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">35</span>
                <span class="site-state-item-name">tags</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/wt-git-repository" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                    
                      GitHub
                    
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="endawt.lin@gmail.com" target="_blank" title="E-Mail">
                  
                    <i class="fa fa-fw fa-envelope"></i>
                  
                    
                      E-Mail
                    
                </a>
              </span>
            
          
        </div>

        
        

        
        

        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#基本概念"><span class="nav-number">1.</span> <span class="nav-text">基本概念</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#连接MySQL"><span class="nav-number">2.</span> <span class="nav-text">连接MySQL</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#TCP-IP"><span class="nav-number">2.1.</span> <span class="nav-text">TCP/IP</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#InnoDB-体系架构"><span class="nav-number">3.</span> <span class="nav-text">InnoDB 体系架构</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#后台线程"><span class="nav-number">3.1.</span> <span class="nav-text">后台线程</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Master-Thread"><span class="nav-number">3.1.1.</span> <span class="nav-text">Master Thread</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#IO-Thread"><span class="nav-number">3.1.2.</span> <span class="nav-text">IO Thread</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Purge-Thread"><span class="nav-number">3.1.3.</span> <span class="nav-text">Purge Thread</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Page-Cleaner-Thread"><span class="nav-number">3.1.4.</span> <span class="nav-text">Page Cleaner Thread</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#内存"><span class="nav-number">3.2.</span> <span class="nav-text">内存</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#缓冲池"><span class="nav-number">3.2.1.</span> <span class="nav-text">缓冲池</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#文件"><span class="nav-number">3.3.</span> <span class="nav-text">文件</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#表"><span class="nav-number">3.4.</span> <span class="nav-text">表</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#索引组织表"><span class="nav-number">3.4.1.</span> <span class="nav-text">索引组织表</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#InnoDB-逻辑存储结构"><span class="nav-number">3.4.2.</span> <span class="nav-text">InnoDB 逻辑存储结构</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#InnoDB-行记录格式"><span class="nav-number">3.4.3.</span> <span class="nav-text">InnoDB 行记录格式</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Compact-行记录格式"><span class="nav-number">3.4.3.1.</span> <span class="nav-text">Compact 行记录格式</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#索引与算法"><span class="nav-number">3.5.</span> <span class="nav-text">索引与算法</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#聚集索引"><span class="nav-number">3.5.1.</span> <span class="nav-text">聚集索引</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#非聚集索引"><span class="nav-number">3.5.2.</span> <span class="nav-text">非聚集索引</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#聚集索引和非聚集索引的关系"><span class="nav-number">3.5.3.</span> <span class="nav-text">聚集索引和非聚集索引的关系</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Cardinality-值"><span class="nav-number">3.6.</span> <span class="nav-text">Cardinality 值</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#什么时候添加B-树索引会比较合适"><span class="nav-number">3.6.1.</span> <span class="nav-text">什么时候添加B+ 树索引会比较合适</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#如何查看索引是否是高选择性"><span class="nav-number">3.6.2.</span> <span class="nav-text">如何查看索引是否是高选择性</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#什么是Cardinality-值"><span class="nav-number">3.6.3.</span> <span class="nav-text">什么是Cardinality 值</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#InnoDB-是如何统计Cardinality"><span class="nav-number">3.6.4.</span> <span class="nav-text">InnoDB 是如何统计Cardinality</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#锁"><span class="nav-number">3.7.</span> <span class="nav-text">锁</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#lock-and-latch"><span class="nav-number">3.7.1.</span> <span class="nav-text">lock and latch</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#InnoDB-存储引擎中的锁"><span class="nav-number">3.7.2.</span> <span class="nav-text">InnoDB 存储引擎中的锁</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#锁lock-的类型"><span class="nav-number">3.7.2.1.</span> <span class="nav-text">锁lock 的类型</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#一致性非锁定读"><span class="nav-number">3.7.2.2.</span> <span class="nav-text">一致性非锁定读</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#一致性锁定读"><span class="nav-number">3.7.2.3.</span> <span class="nav-text">一致性锁定读</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#死锁"><span class="nav-number">3.7.3.</span> <span class="nav-text">死锁</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#死锁避免"><span class="nav-number">3.7.3.1.</span> <span class="nav-text">死锁避免</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#事务"><span class="nav-number">3.8.</span> <span class="nav-text">事务</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#事务的实现"><span class="nav-number">3.9.</span> <span class="nav-text">事务的实现</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#redo"><span class="nav-number">3.9.1.</span> <span class="nav-text">redo</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#undo"><span class="nav-number">3.9.2.</span> <span class="nav-text">undo</span></a></li></ol></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Enda Lin</span>
</div>



        
<div class="busuanzi-count">
  <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="site-uv">
      <i class="fa fa-user"></i> 您是博主的第
      <span class="busuanzi-value" id="busuanzi_value_site_uv"></span>
      位小伙伴
    </span>
  

  
    <span class="site-pv">
      <i class="fa fa-eye"></i> 总访问量
      <span class="busuanzi-value" id="busuanzi_value_site_pv"></span>
      次
    </span>
  
</div>


        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.2"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.2"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.2"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.2"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.2"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.2"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.2"></script>



  











  <link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css">
  <script src="/js/md5.min.js"></script>
  <script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script>
   <script type="text/javascript">
        var gitalk = new Gitalk({
          clientID: 'afbcc6e2a54ed4e2ebd7',
          clientSecret: '6c36028e964ef689580f33ec9bd19b720f5f131f',
          repo: 'wt-git-repository.github.io',
          owner: 'wt-git-repository',
          admin: ['wt-git-repository'],
          id: md5(location.href),
          distractionFreeMode: false
        })
        gitalk.render('gitalk-container')
       </script>



  





  

  

  

  

  

  

</body>
</html>
